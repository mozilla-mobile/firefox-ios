name: Comment App Version on Merged PR

on:
  push:
    branches:
      - main

jobs:
  comment-version:
    runs-on: ubuntu-latest

    steps:
      - name: Check out main
        uses: actions/checkout@v4

      - name: Read version.txt
        id: get_version
        run: echo "version=$(cat version.txt)" >> $GITHUB_OUTPUT

      - name: Get PR number for this merge commit
        id: get_pr
        run: |
          pr_number=$(gh pr list --search "${{ github.sha }}" --state merged --json number --jq '.[0].number')
          if [ -z "$pr_number" ]; then
            echo "No merged PR found for commit ${{ github.sha }}. Likely a direct push to main. Skipping comment."
          fi
          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: steps.get_pr.outputs.pr_number != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.get_pr.outputs.pr_number }}
          body: |
            ðŸš€ PR merged to `main`, targeting version: `${{ steps.get_version.outputs.version }}`
